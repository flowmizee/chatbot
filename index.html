const API_KEY = 'AIzaSyBZWq79odwHX5NnccXU_1Y9_SSYAAuPg3Q';
const BASE_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent';

/**
 * Responde a requisições HTTP GET e serve o HTML do cliente.
 */
function doGet() {
  return HtmlService
    .createTemplateFromFile('Index')
    .evaluate()
    .setTitle('Chat Web Estilo WhatsApp')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

/**
 * Inclui arquivos separados (ex.: CSS/JS) no HTML.
 */
function include(filename) {
  return HtmlService.createHtmlOutputFromFile(filename).getContent();
}

/**
 * Handler principal do chat.
 */
function handleChat(message) {
  // lógica de produtos
  if (/receita|comprar|produto/i.test(message)) {
    return {
      response: 'Temos estas opções disponíveis:',
      products: [
        { title: '✅ 50 Receitas de Pães Sem Glúten', price: 'R$ 9,99', description: '50 receitas exclusivas sem glúten' },
        { title: '✅ Pacote Completo Guia Receitas Saudáveis', price: 'R$ 19,99', description: 'Mais de 100 receitas saudáveis' }
      ]
    };
  }

  // chamada à API Gemini
  const prompt = `Você é a Chef Larissa Campos, especialista em culinária saudável. ` +
                 `Responda de forma simpática e profissional a: "${message}" ` +
                 `(Máximo 2 parágrafos). Se for sobre compras, ofereça nossas opções.`;
  const text = callGeminiAPI(prompt);
  return { response: text || 'Desculpe, não entendi. Poderia reformular?' };
}

/**
 * Seleção de produto.
 */
function handleSelectProduct(index) {
  const products = [
    { title: '50 Receitas de Pães Sem Glúten', price: 'R$ 9,99', pixKey: 'renimarfilho000@gmail.com', recipientName: 'Antonio Renimar Pinheiro Almeida', city: 'São Luís, MA', amount: 'R$ 9,99', description: '50 Receitas de Pães Sem Glúten' },
    { title: 'Pacote Completo Guia Receitas Saudáveis', price: 'R$ 19,99', pixKey: 'renimarfilho000@gmail.com', recipientName: 'Antonio Renimar Pinheiro Almeida', city: 'São Luís, MA', amount: 'R$ 19,99', description: 'Pacote Completo Guia Receitas Saudáveis' }
  ];
  const sel = products[index];
  if (!sel) return { error: 'Produto não encontrado' };

  const qrData = {
    pixKey: sel.pixKey,
    merchantName: sel.recipientName,
    merchantCity: sel.city.split(',')[0].trim(),
    amount: parseFloat(sel.amount.replace('R$ ', '').replace(',', '.')),
    description: sel.description,
    txid: Utilities.getUuid().slice(0,25)
  };
  const qrCode = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(JSON.stringify(qrData))}`;

  return { ...sel, qrCode: qrCode, transactionId: qrData.txid };
}

/**
 * Confirmação de pagamento.
 */
function handleConfirmPayment(txid) {
  Utilities.sleep(2000);
  return { success: true, transactionId: txid, confirmationCode: 'PAY-' + Math.floor(Math.random()*1e6) };
}

/**
 * Gera conteúdo do produto.
 */
function handleGetProductContent(txid) {
  const type = txid.includes('gluten') ? '50 receitas de pães sem glúten' : 'pacote completo de guia de receitas saudáveis';
  const prompt = `Gere 3 exemplos de receitas (dentre as ${type} compradas). Cada receita deve incluir título, ingredientes e modo de preparo em HTML.`;
  try {
    const html = callGeminiAPI(prompt);
    return { content: html, audioUrl: `https://example.com/audio/${txid}.mp3` };
  } catch (e) {
    return { content: 'Seu material está pronto! Em breve envio por email.' };
  }
}

/**
 * Chama a API Gemini.
 */
function callGeminiAPI(prompt) {
  const payload = {
    contents: [{ parts: [{ text: prompt }] }],
    safetySettings: [{ category: 'HARM_CATEGORY_HARASSMENT', threshold: 'BLOCK_ONLY_HIGH' }],
    generationConfig: { maxOutputTokens: 2000 }
  };
  const opts = {
    method: 'post',
    contentType: 'application/json',
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };
  const res = UrlFetchApp.fetch(`${BASE_URL}?key=${API_KEY}`, opts);
  const j = JSON.parse(res.getContentText());
  if (j.candidates?.[0]?.content?.parts?.[0]?.text) return j.candidates[0].content.parts[0].text;
  throw new Error('Resposta inesperada da API');
}
