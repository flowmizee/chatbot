<!DOCTYPE html>  
<html lang="pt-BR">  
  <head>  
    <meta charset="UTF-8" />    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>    
    <title>Chat Web Estilo WhatsApp</title>    
    <style>    
      html, body {    
        margin: 0;    
        padding: 0;    
        font-family: 'Segoe UI', sans-serif;    
        height: 100%;    
        background-color: #ece5dd;    
      }    
      body {    
        display: flex;    
        justify-content: center;    
        align-items: center;    
      }    
      .chat-container {    
        width: 100%;    
        height: 100dvh;    
        max-width: 430px;    
        background-color: #fff;    
        display: flex;    
        flex-direction: column;    
        box-shadow: 0 0 10px rgba(0,0,0,0.2);    
      }    
      .chat-header {    
        background-color: #075E54;    
        padding: 10px 15px;    
        display: flex;    
        align-items: center;    
        color: white;    
      }    
      .chat-header img {    
        width: 45px;    
        height: 45px;    
        border-radius: 50%;    
        margin-right: 12px;    
        object-fit: cover;    
      }    
      .chat-header .name {    
        font-size: 18px;    
        font-weight: bold;    
      }    
      .chat-body {    
        flex: 1;    
        padding: 15px;    
        overflow-y: auto;    
        background-color: #e5ddd5;    
        display: flex;    
        flex-direction: column;    
      }    
      .message {    
        max-width: 75%;    
        padding: 10px 14px;    
        margin-bottom: 8px;    
        font-size: 15px;    
        border-radius: 8px;    
        line-height: 1.4;    
        word-wrap: break-word;    
      }    
      .user {    
        align-self: flex-end;    
        background-color: #dcf8c6;    
        border-bottom-right-radius: 0;    
      }    
      .bot {    
        align-self: flex-start;    
        background-color: white;    
        border-bottom-left-radius: 0;    
      }    
      .typing-indicator {    
        align-self: flex-start;    
        background-color: white;    
        border-bottom-left-radius: 0;    
        max-width: 50px;    
        height: 24px;    
        display: flex;    
        align-items: center;    
        justify-content: center;    
        border-radius: 8px;    
        margin-bottom: 8px;    
        padding: 5px 10px;    
      }    
      .typing-indicator span {    
        display: inline-block;    
        width: 6px;    
        height: 6px;    
        margin: 0 1px;    
        background-color: #999;    
        border-radius: 50%;    
        animation: blink 1.4s infinite both;    
      }    
      .typing-indicator span:nth-child(2) {    
        animation-delay: 0.2s;    
      }    
      .typing-indicator span:nth-child(3) {    
        animation-delay: 0.4s;    
      }    
      @keyframes blink {    
        0%, 80%, 100% { opacity: 0; }    
        40% { opacity: 1; }    
      }    
      .chat-footer {    
        display: flex;    
        padding: 8px 10px;    
        background-color: #fff;    
        border-top: 1px solid #ccc;    
      }    
      .chat-footer input {    
        flex: 1;    
        padding: 12px;    
        border: none;    
        font-size: 16px;    
        border-radius: 20px;    
        margin-right: 8px;    
        background-color: #f0f0f0;    
        outline: none;    
      }    
      .chat-footer button {    
        background-color: #075E54;    
        color: white;    
        border: none;    
        padding: 10px 16px;    
        font-size: 16px;    
        border-radius: 20px;    
        cursor: pointer;    
      }    
      .chat-footer button:hover {    
        background-color: #0b7a67;    
      }    
      .loading {    
        display: inline-block;    
        width: 20px;    
        height: 20px;    
        border: 3px solid rgba(255,255,255,.3);    
        border-radius: 50%;    
        border-top-color: #075E54;    
        animation: spin 1s ease-in-out infinite;    
      }    
      .option-buttons {    
        display: flex;    
        gap: 10px;    
        margin-top: 10px;    
      }    
      .option-button {    
        background-color: #075E54;    
        color: white;    
        border: none;    
        padding: 8px 12px;    
        border-radius: 20px;    
        cursor: pointer;    
        font-size: 14px;    
      }    
      .option-button:hover {    
        background-color: #0b7a67;    
      }    
      .preview-image {    
        max-width: 100%;    
        border-radius: 8px;    
        margin-top: 10px;    
      }    
      .buy-button {    
        background-color: #25D366;    
        color: white;    
        border: none;    
        padding: 12px 20px;    
        border-radius: 20px;    
        cursor: pointer;    
        font-size: 16px;    
        font-weight: bold;    
        margin-top: 15px;    
        display: inline-block;    
      }    
      .buy-button:hover {    
        background-color: #128C7E;    
      }    
      @keyframes spin {    
        to { transform: rotate(360deg); }    
      }    
    </style>    
  </head>    
  <body>    
    <div class="chat-container">    
      <div class="chat-header">    
        <img src="perfil.webp" alt="Perfil">    
        <div class="name">Chef Larissa Campos</div>    
      </div>  
      <div class="chat-body" id="chatBody"></div>    
      <div class="chat-footer">    
        <input type="text" id="userInput" placeholder="Digite sua mensagem..." onkeypress="handleKeyPress(event)">    
        <button onclick="sendMessage()" id="sendButton">Enviar</button>    
      </div>    
    </div>    
    <script>    
      const GEMINI_API_KEY = 'AIzaSyBZWq79odwHX5NnccXU_1Y9_SSYAAuPg3Q';    
      const GEMINI_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent';    
      const CHECKOUT_URL = 'https://pay.kiwify.com.br/68vs72A'; // Link de checkout direto
      let isWaitingResponse = false;    
      let typingEl = null;    
      let conversationStage = 0; // 0 = in√≠cio, 1 = mostrou preview, 2 = mostrou bot√£o de compra
    
      window.onload = async () => {
        await simulateTyping("üë©‚Äçüç≥ <strong>Chef Larissa Campos:</strong><br>Ol√° tudo bem? Eu me chamo Larissa Campos, fico feliz que esteja interessada na minhas Receitinhas saud√°veis.");
        await simulateTyping("üçûVoc√™ est√° diante da oportunidade de aprender a fazer receitas sem gl√∫ten incr√≠veis, fofinhos e deliciosos, que v√£o surpreender todo mundo!<br><br>- 50 receitas exclusivas<br>- Sem Gl√∫ten e Sem Lactose<br>- Ingredientes de f√°cil acesso<br>- ‚Å†Suporte no Whatsapp<br>- Acesso Vital√≠cio<br><br>üî¥Tudo isso por apenas <strong>R$ 9,90</strong>!");
        await simulateTyping(`‚ú® Posso te mostrar uma pr√©via?  
          Voc√™ vai se surpreender com o que tem l√° üòç  
          <br><br>  
          üëá Escolhe uma op√ß√£o aqui rapidinho:  
          <div class="option-buttons">  
            <button class="option-button" onclick="handleOptionClick('Sim')">Sim ü•π</button>  
            <button class="option-button" onclick="handleOptionClick('Quero ver')">Quero ver üòç</button>  
          </div>`);
      };
      
      async function handleOptionClick(option) {
        appendMessage("user", option);
        await simulateTyping(""); // Mostra o indicador de digita√ß√£o
        showPreviewImages();
      }
      
      async function showPreviewImages() {
        conversationStage = 1;
        const imagesHTML = `  
          <div style="margin-top: 10px;">  
            <p>Aqui est√° uma pr√©via do que voc√™ vai encontrar no ebook:</p>  
            <img src="receita1.webp" alt="Receita 1" class="preview-image">  
            <img src="receita2.webp" alt="Receita 2" class="preview-image">  
            <p>üòç Impressionante, n√©? S√£o 50 receitas incr√≠veis!</p>
            <p>O que voc√™ achou? Posso te mostrar como adquirir?</p>
            <div class="option-buttons">  
              <button class="option-button" onclick="handleBuyInterest('Sim, quero comprar')">Sim, quero comprar</button>  
              <button class="option-button" onclick="handleBuyInterest('Mais informa√ß√µes')">Mais informa√ß√µes</button>  
            </div>
          </div>  
        `;
        await simulateTyping(imagesHTML);
      }
      
      async function handleBuyInterest(option) {
        appendMessage("user", option);
        await simulateTyping("");
        
        if (option.includes("comprar")) {
          await showBuyButton(true);
        } else {
          // Resposta para mais informa√ß√µes
          await simulateTyping("Claro! O ebook cont√©m 50 receitas testadas e aprovadas, todas sem gl√∫ten e sem lactose, com ingredientes f√°ceis de encontrar. Voc√™ ter√° acesso vital√≠cio e poder√° baixar para ver quando quiser!");
          await showBuyButton(false);
        }
      }
      
      function redirectToCheckout() {
        window.location.href = CHECKOUT_URL;
      }

      function handleKeyPress(event) {
        if (event.key === 'Enter' && !isWaitingResponse) {
          sendMessage();
        }
      }

      async function sendMessage() {
        if (isWaitingResponse) return;

        const inputEl = document.getElementById("userInput");
        const text = inputEl.value.trim();
        if (!text) return;

        appendMessage("user", text);
        inputEl.value = "";
        isWaitingResponse = true;
        toggleLoading(true);
        showTypingIndicator();

        // Verifica se a mensagem do usu√°rio pede para ver as imagens
        if (shouldShowPreview(text) && conversationStage < 1) {
          hideTypingIndicator();
          await showPreviewImages();
          isWaitingResponse = false;
          toggleLoading(false);
          return;
        }

        // Prompt fixo para manter o contexto da Chef Larissa
        const systemPrompt = `
        Voc√™ √© a Chef Larissa Campos, especialista em receitas saud√°veis sem gl√∫ten e sem lactose. 
        Voc√™ est√° vendendo um ebook com 50 receitas por R$ 9,90. 
        Seu objetivo √© responder perguntas sobre as receitas e convencer o cliente a comprar.
        
        Regras importantes:
        1. Nunca saia do personagem da Chef Larissa
        2. Sempre mantenha um tom amig√°vel e profissional
        3. Foque nas receitas saud√°veis sem gl√∫ten e sem lactose
        4. Sempre direcione para a venda do ebook de R$ 9,90
        5. Se perguntarem sobre pre√ßo, refor√ßar que s√£o apenas R$ 9,90
        6. Para d√∫vidas sobre pagamento, dizer que √© via Kiwify com checkout seguro
        7. Se n√£o souber responder, diga que vai pesquisar e retornar
        8. NUNCA mostre links, apenas direcione para o bot√£o de compra
        
        Hist√≥rico da conversa:
        - Voc√™ j√° mostrou a capa, sum√°rio e uma receita de exemplo
        - O cliente j√° sabe que s√£o 50 receitas por R$ 9,90
        `;

        const finalPrompt = systemPrompt + "\n\nCliente: " + text + "\nLarissa:";

        try {
          const res = await fetch(`${GEMINI_URL}?key=${GEMINI_API_KEY}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{ parts: [{ text: finalPrompt }] }]
            })
          });

          const data = await res.json();        
          hideTypingIndicator();        

          if (data.error) {        
            appendMessage("bot", "‚ùå Erro Gemini: " + data.error.message);        
          } else {        
            const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || 'Sem resposta';        
            await simulateTyping(reply);        
            
            // Se a resposta cont√©m termos de compra ou o usu√°rio demonstrou interesse, mostra o bot√£o
            if (shouldShowBuyButtonBasedOnResponse(reply) || shouldShowBuyButton(text)) {
              const immediateBuy = text.toLowerCase().includes("comprar") || 
                                text.toLowerCase().includes("quero") || 
                                text.toLowerCase().includes("compra agora");
              await showBuyButton(immediateBuy);
            }
          }

        } catch (err) {
          console.error(err);
          hideTypingIndicator();
          appendMessage("bot", "‚ùå Falha na conex√£o com a API.");
        } finally {
          isWaitingResponse = false;
          toggleLoading(false);
        }
      }

      function shouldShowPreview(message) {
        const lowerMsg = message.toLowerCase();
        return (
          lowerMsg.includes('ver') || 
          lowerMsg.includes('mostrar') || 
          lowerMsg.includes('pr√©via') || 
          lowerMsg.includes('previa') || 
          lowerMsg.includes('exemplo') || 
          lowerMsg.includes('imagem') || 
          lowerMsg.includes('foto')
        ) && conversationStage < 1;
      }

      function shouldShowBuyButton(message) {
        const lowerMsg = message.toLowerCase();
        return (
          lowerMsg.includes('comprar') || 
          lowerMsg.includes('compra') || 
          lowerMsg.includes('quero') || 
          lowerMsg.includes('adquirir') || 
          lowerMsg.includes('pagamento') ||
          lowerMsg.includes('pre√ßo') ||
          lowerMsg.includes('valor') ||
          lowerMsg.includes('como fa√ßo') ||
          lowerMsg.includes('como compro') ||
          lowerMsg.includes('interessado') ||
          lowerMsg.includes('interessada') ||
          lowerMsg.includes('desejo') ||
          lowerMsg.includes('como adquirir')
        );
      }

      function shouldShowBuyButtonBasedOnResponse(response) {
        const lowerRes = response.toLowerCase();
        return (
          lowerRes.includes('comprar') || 
          lowerRes.includes('bot√£o') || 
          lowerRes.includes('pagamento') ||
          lowerRes.includes('checkout') ||
          lowerRes.includes('kiwify') ||
          lowerRes.includes('adquirir') ||
          lowerRes.includes('quero') ||
          lowerRes.includes('valor') ||
          lowerRes.includes('pre√ßo')
        );
      }

      async function showBuyButton(immediateBuy) {
        conversationStage = 2;
        let buyMessage;
        
        if (immediateBuy) {
          buyMessage = `
            üéâ Perfeito! Voc√™ fez uma √≥tima escolha!
            <br><br>
            Clique no bot√£o abaixo para garantir seu acesso imediato por apenas R$ 9,90:
            <br><br>
            <button class="buy-button" onclick="redirectToCheckout()">QUERO COMPRAR AGORA!</button>
          `;
        } else {
          buyMessage = `
            Se interessou pelas receitas? Por apenas R$ 9,90 voc√™ leva todas essas del√≠cias para sua casa!
            <br><br>
            <button class="buy-button" onclick="redirectToCheckout()">QUERO COMPRAR AGORA!</button>
            <br><br>
            Qualquer d√∫vida √© s√≥ me chamar! Estou aqui para te ajudar üòä
          `;
        }
        
        await simulateTyping(buyMessage);
      }

      function appendMessage(sender, message) {
        const chatBody = document.getElementById("chatBody");
        const msgEl = document.createElement("div");
        msgEl.className = `message ${sender}`;
        msgEl.innerHTML = message;
        chatBody.appendChild(msgEl);
        chatBody.scrollTop = chatBody.scrollHeight;
      }

      function toggleLoading(show) {
        const btn = document.getElementById("sendButton");
        if (show) {
          btn.innerHTML = '<div class="loading"></div>';
          btn.disabled = true;
        } else {
          btn.textContent = 'Enviar';
          btn.disabled = false;
        }
      }

      function showTypingIndicator() {
        if (!typingEl) {
          typingEl = document.createElement("div");
          typingEl.className = "typing-indicator";
          typingEl.innerHTML = "<span></span><span></span><span></span>";
          document.getElementById("chatBody").appendChild(typingEl);
          document.getElementById("chatBody").scrollTop = document.getElementById("chatBody").scrollHeight;
        }
      }

      function hideTypingIndicator() {
        if (typingEl) {
          typingEl.remove();
          typingEl = null;
        }
      }

      async function simulateTyping(message, delay = 2500) {
        showTypingIndicator();
        await new Promise(r => setTimeout(r, delay));
        hideTypingIndicator();
        if (message) { // S√≥ adiciona a mensagem se n√£o for vazia
          appendMessage("bot", message);
        }
      }
    </script>  
  </body>
</html>
