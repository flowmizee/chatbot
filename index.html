<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
    <title>Chat Web Estilo WhatsApp</title>
    <style>
      html, body {
        margin: 0;
        padding: 0;
        font-family: 'Segoe UI', sans-serif;
        height: 100%;
        background-color: #ece5dd;
      }
      body {
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .chat-container {
        width: 100%;
        height: 100dvh;
        max-width: 430px;
        background-color: #fff;
        display: flex;
        flex-direction: column;
        box-shadow: 0 0 10px rgba(0,0,0,0.2);
      }
      .chat-header {
        background-color: #075E54;
        padding: 10px 15px;
        display: flex;
        align-items: center;
        color: white;
      }
      .chat-header img {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        margin-right: 12px;
        object-fit: cover;
      }
      .chat-header .name {
        font-size: 18px;
        font-weight: bold;
      }
      .chat-body {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
        background-color: #e5ddd5;
        display: flex;
        flex-direction: column;
      }
      .message {
        max-width: 75%;
        padding: 10px 14px;
        margin-bottom: 8px;
        font-size: 15px;
        border-radius: 8px;
        line-height: 1.4;
        word-wrap: break-word;
      }
      .user {
        align-self: flex-end;
        background-color: #dcf8c6;
        border-bottom-right-radius: 0;
      }
      .bot {
        align-self: flex-start;
        background-color: white;
        border-bottom-left-radius: 0;
      }
      .typing-indicator {
        align-self: flex-start;
        background-color: white;
        border-bottom-left-radius: 0;
        max-width: 50px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        margin-bottom: 8px;
        padding: 5px 10px;
      }
      .typing-indicator span {
        display: inline-block;
        width: 6px;
        height: 6px;
        margin: 0 1px;
        background-color: #999;
        border-radius: 50%;
        animation: blink 1.4s infinite both;
      }
      .typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
      }
      .typing-indicator span:nth-child(3) {
        animation-delay: 0.4s;
      }
      @keyframes blink {
        0%, 80%, 100% { opacity: 0; }
        40% { opacity: 1; }
      }
      .chat-footer {
        display: flex;
        padding: 8px 10px;
        background-color: #fff;
        border-top: 1px solid #ccc;
      }
      .chat-footer input {
        flex: 1;
        padding: 12px;
        border: none;
        font-size: 16px;
        border-radius: 20px;
        margin-right: 8px;
        background-color: #f0f0f0;
        outline: none;
      }
      .chat-footer button {
        background-color: #075E54;
        color: white;
        border: none;
        padding: 10px 16px;
        font-size: 16px;
        border-radius: 20px;
        cursor: pointer;
      }
      .chat-footer button:hover {
        background-color: #0b7a67;
      }
      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255,255,255,.3);
        border-radius: 50%;
        border-top-color: #075E54;
        animation: spin 1s ease-in-out infinite;
      }
      .option-buttons {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }
      .option-button {
        background-color: #075E54;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
      }
      .option-button:hover {
        background-color: #0b7a67;
      }
      .preview-image {
        max-width: 100%;
        border-radius: 8px;
        margin-top: 10px;
      }
      .buy-button {
        background-color: #25D366;
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        margin-top: 15px;
        display: inline-block;
      }
      .buy-button:hover {
        background-color: #128C7E;
      }
      .pix-code {
        width: 100%;
        padding: 8px;
        margin: 5px 0;
        border: 1px solid #ccc;
        border-radius: 4px;
        background: #f9f9f9;
      }
      .copy-button {
        background-color: #075E54;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 20px;
        cursor: pointer;
        margin-bottom: 10px;
      }
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <img src="perfil.webp" alt="Perfil">
            <div class="name">Chef Larissa Campos</div>
        </div>
        <div class="chat-body" id="chatBody"></div>
        <div class="chat-footer">
            <input type="text" id="userInput" placeholder="Digite sua mensagem..." onkeypress="handleKeyPress(event)">
            <button onclick="sendMessage()" id="sendButton">Enviar</button>
        </div>
    </div>

    <script>
        // Configura√ß√£o do Apps Script (substitua pela sua URL)
        const APP_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxonvkt_ZtK-epkKQwJkIxchjl70liMIkQxiVSblcbMFPmrsY-6AXIl8EdZwOLrjle75w/exec";
        let currentTxid = null;
        let paymentCheckInterval = null;
        let isWaitingResponse = false;
        let typingEl = null;

        // Inicializa√ß√£o do chat
        window.onload = async () => {
            await simulateTyping("üë©‚Äçüç≥ <strong>Chef Larissa Campos:</strong><br>Ol√° tudo bem? Eu me chamo Larissa Campos, fico feliz que esteja interessada na minhas Receitinhas saud√°veis.");
            await simulateTyping("üçû Voc√™ est√° diante da oportunidade de aprender a fazer receitas sem gl√∫ten incr√≠veis, fofinhos e deliciosos, que v√£o surpreender todo mundo!<br><br>- 50 receitas exclusivas<br>- Sem Gl√∫ten e Sem Lactose<br>- Ingredientes de f√°cil acesso<br>- ‚Å†Suporte no Whatsapp<br>- Acesso Vital√≠cio<br><br>üî¥ Tudo isso por apenas <strong>R$ 9,90</strong>!");
            await simulateTyping(`‚ú® Posso te mostrar uma pr√©via?    
                Voc√™ vai se surpreender com o que tem l√° üòç    
                <br><br>    
                üëá Escolhe uma op√ß√£o aqui rapidinho:    
                <div class="option-buttons">
                    <button class="option-button" onclick="sendOption('Sim')">Sim ü•π</button>
                    <button class="option-button" onclick="sendOption('Quero ver')">Quero ver üòç</button>
                </div>`);
        };

        function sendOption(option) {
            appendMessage("user", option);
            showPreviewImages();
        }

        function showPreviewImages() {
            const imagesHTML = `
                <div style="margin-top: 10px;">
                    <p>Aqui est√° uma pr√©via do que voc√™ vai encontrar no ebook:</p>
                    <img src="capa.webp" alt="Capa do Ebook" class="preview-image">
                    <img src="sumario.webp" alt="Sum√°rio" class="preview-image">
                    <img src="receita.webp" alt="Exemplo de Receita" class="preview-image">
                    <p>üòç Impressionante, n√©? S√£o 50 receitas como essa!</p>
                    <p>Se interessou? Escolha como quer pagar:</p>
                    <button class="buy-button" onclick="generatePixPayment()">PAGAR COM PIX (R$ 9,90)</button>
                </div>
            `;
            appendMessage("bot", imagesHTML);
        }

        async function generatePixPayment() {
            appendMessage("user", "Quero pagar via PIX");
            isWaitingResponse = true;
            toggleLoading(true);
            
            try {
                const response = await fetch(APP_SCRIPT_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        action: "generatePix",
                        valor: "9.90"
                    })
                });
                
                const data = await response.json();
                
                if (data.status === "success") {
                    currentTxid = data.txid;
                    
                    const paymentHTML = `
                        <div style="text-align: center;">
                            <p>üíñ Aqui est√° seu QR Code para pagamento de R$ 9,90:</p>
                            <img src="${data.qrCodeImage}" alt="QR Code PIX" style="width: 200px; height: 200px; margin: 10px auto; border: 1px solid #ddd;">
                            <p>Ou copie o c√≥digo PIX:</p>
                            <input type="text" id="pixCodeInput" value="${data.qrCode}" readonly class="pix-code">
                            <button onclick="copyPixCode()" class="copy-button">Copiar C√≥digo</button>
                            <p>Este QR Code √© v√°lido por 30 minutos ‚è≥</p>
                            <div id="paymentStatus" style="margin: 10px 0; font-weight: bold; color: #D32F2F;">
                                ‚åõ Aguardando confirma√ß√£o de pagamento...
                            </div>
                            <button class="buy-button" onclick="checkPaymentStatus()">J√Å PAGUEI, VERIFICAR</button>
                        </div>
                    `;
                    
                    appendMessage("bot", paymentHTML);
                    startPaymentVerification();
                }
            } catch (error) {
                appendMessage("bot", "‚ùå Ocorreu um erro ao gerar o PIX. Tente novamente.");
            } finally {
                isWaitingResponse = false;
                toggleLoading(false);
            }
        }

        function startPaymentVerification() {
            // Verifica a cada 30 segundos se foi pago
            paymentCheckInterval = setInterval(checkPaymentStatus, 30000);
        }

        async function checkPaymentStatus() {
            if (!currentTxid) return;
            
            isWaitingResponse = true;
            toggleLoading(true);
            
            try {
                const response = await fetch(APP_SCRIPT_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        action: "checkPayment",
                        txid: currentTxid
                    })
                });
                
                const data = await response.json();
                const statusEl = document.getElementById("paymentStatus");
                
                if (data.pago) {
                    clearInterval(paymentCheckInterval);
                    statusEl.innerHTML = "‚úÖ Pagamento confirmado!";
                    statusEl.style.color = "#25D366";
                    appendMessage("bot", "üéâ Pagamento confirmado! Seu ebook ser√° enviado por email em instantes!");
                } else {
                    statusEl.innerHTML = "‚åõ Ainda n√£o identificamos seu pagamento...";
                }
            } catch (error) {
                console.error("Erro na verifica√ß√£o:", error);
            } finally {
                isWaitingResponse = false;
                toggleLoading(false);
            }
        }

        function copyPixCode() {
            const pixCodeInput = document.getElementById("pixCodeInput");
            pixCodeInput.select();
            document.execCommand("copy");
            alert("C√≥digo PIX copiado! Agora cole no seu app banc√°rio.");
        }

        // Fun√ß√µes auxiliares originais (mantidas intactas)
        function appendMessage(sender, message) {
            const chatBody = document.getElementById("chatBody");
            const msgEl = document.createElement("div");
            msgEl.className = `message ${sender}`;
            msgEl.innerHTML = message;
            chatBody.appendChild(msgEl);
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        async function simulateTyping(message, delay = 2000) {
            showTypingIndicator();
            await new Promise(r => setTimeout(r, delay));
            hideTypingIndicator();
            appendMessage("bot", message);
        }

        function showTypingIndicator() {
            if (!typingEl) {
                typingEl = document.createElement("div");
                typingEl.className = "typing-indicator";
                typingEl.innerHTML = "<span></span><span></span><span></span>";
                document.getElementById("chatBody").appendChild(typingEl);
                document.getElementById("chatBody").scrollTop = document.getElementById("chatBody").scrollHeight;
            }
        }

        function hideTypingIndicator() {
            if (typingEl) {
                typingEl.remove();
                typingEl = null;
            }
        }

        function toggleLoading(show) {
            const btn = document.getElementById("sendButton");
            if (show) {
                btn.innerHTML = '<div class="loading"></div>';
                btn.disabled = true;
            } else {
                btn.textContent = 'Enviar';
                btn.disabled = false;
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !isWaitingResponse) {
                sendMessage();
            }
        }

        function sendMessage() {
            if (isWaitingResponse) return;

            const inputEl = document.getElementById("userInput");
            const text = inputEl.value.trim();
            if (!text) return;

            appendMessage("user", text);
            inputEl.value = "";
            
            // Resposta padr√£o para mensagens n√£o relacionadas ao PIX
            if (!currentTxid) {
                simulateTyping("Por favor, escolha uma das op√ß√µes de pagamento acima para continuar üòä");
            }
        }
    </script>
</body>
</html>
